<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de √ìrdenes - Gestor de √ìrdenes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="../index.html">
                <i class="bi bi-clipboard-heart"></i> Gestor de √ìrdenes
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link active" href="ordenes.html">
                    <i class="bi bi-file-earmark-medical"></i> √ìrdenes
                </a>
                <a class="nav-link" href="agenda.html">
                    <i class="bi bi-calendar3"></i> Agenda
                </a>
                <a class="nav-link" href="checkin.html">
                    <i class="bi bi-check-circle"></i> Check-in
                </a>
                <a class="nav-link" href="presentaciones.html">
                    <i class="bi bi-file-earmark-spreadsheet"></i> Presentaciones
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1><i class="bi bi-file-earmark-medical"></i> Gesti√≥n de √ìrdenes</h1>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#nuevaOrdenModal">
                        <i class="bi bi-plus-circle"></i> Nueva Orden
                    </button>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-funnel"></i> Filtros</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-2">
                                <label class="form-label">Estado</label>
                                <select class="form-select" id="filtroEstado">
                                    <option value="">Todos</option>
                                    <option value="Abierta">Abierta</option>
                                    <option value="Cerrada Normal">Cerrada Normal</option>
                                    <option value="Cerrada Manual">Cerrada Manual</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Estado de Programaci√≥n</label>
                                <select class="form-select" id="filtroEstadoProgramacion">
                                    <option value="">Todos</option>
                                    <option value="sin_programar">üî¥ Sin Programar</option>
                                    <option value="conflictos">‚ö†Ô∏è Con Conflictos</option>
                                    <option value="programada">‚úÖ Programada</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Paciente</label>
                                <input type="text" class="form-control" id="filtroPaciente" placeholder="Buscar paciente...">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Obra Social</label>
                                <select class="form-select" id="filtroObraSocial">
                                    <option value="">Todas</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Pr√°ctica</label>
                                <select class="form-select" id="filtroPractica">
                                    <option value="">Todas</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <label class="form-label">Fecha Desde</label>
                                <input type="date" class="form-control" id="filtroFechaDesde">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Fecha Hasta</label>
                                <input type="date" class="form-control" id="filtroFechaHasta">
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-end h-100">
                                    <button class="btn btn-secondary me-2" id="limpiarFiltros">
                                        <i class="bi bi-x-circle"></i> Limpiar
                                    </button>
                                    <button class="btn btn-primary me-2" id="aplicarFiltros">
                                        <i class="bi bi-search"></i> Aplicar
                                    </button>
                                    <button class="btn btn-warning" id="programarPendientes">
                                        <i class="bi bi-calendar-plus"></i> Programar Pendientes
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de √ìrdenes -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-list-ul"></i> Lista de √ìrdenes</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Estado</th>
                                        <th>ID</th>
                                        <th>Paciente</th>
                                        <th>DNI</th>
                                        <th>Obra Social</th>
                                        <th>Pr√°ctica</th>
                                        <th>Fecha Emisi√≥n</th>
                                        <th>Progreso</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="ordenesTableBody">
                                    <!-- Se llena din√°micamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nueva Orden -->
    <div class="modal fade" id="nuevaOrdenModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-file-earmark-plus"></i> Nueva Orden</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="ordenForm">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Paciente *</label>
                                <div class="input-group">
                                    <select class="form-select" name="paciente_id" id="pacienteSelect" required>
                                        <option value="">Seleccionar paciente...</option>
                                    </select>
                                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#nuevoPacienteModal">
                                        <i class="bi bi-person-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Obra Social *</label>
                                <select class="form-select" name="obraSocial_id" required>
                                    <option value="">Seleccionar obra social...</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label">M√©dico Derivante</label>
                                <select class="form-select" name="medicoDerivante_id">
                                    <option value="">Seleccionar m√©dico...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Pr√°ctica *</label>
                                <select class="form-select" name="practica_id" required>
                                    <option value="">Seleccionar pr√°ctica...</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label">Fecha de Emisi√≥n *</label>
                                <input type="date" class="form-control" name="fechaEmision" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Cantidad de Sesiones *</label>
                                <input type="number" class="form-control" name="cantidadSesionesTotal" min="1" max="50" required>
                            </div>
                        </div>
                        
                        <!-- Secci√≥n de Programaci√≥n de Sesiones -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="bi bi-calendar3"></i> Programaci√≥n de Sesiones
                                </h6>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Tipo de Programaci√≥n *</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="programacion_tipo" id="prog_habiles" value="habiles" checked>
                                    <label class="form-check-label" for="prog_habiles">
                                        D√≠as H√°biles (Lun - Vie)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="programacion_tipo" id="prog_lmv" value="lmv">
                                    <label class="form-check-label" for="prog_lmv">
                                        Lunes, Mi√©rcoles, Viernes
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="programacion_tipo" id="prog_mtj" value="mtj">
                                    <label class="form-check-label" for="prog_mtj">
                                        Martes, Jueves
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="programacion_tipo" id="prog_personalizada" value="personalizada">
                                    <label class="form-check-label" for="prog_personalizada">
                                        Fechas Personalizadas
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">Hora de Sesiones *</label>
                                        <input type="time" class="form-control" name="hora_sesiones" value="09:00" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Primera Sesi√≥n *</label>
                                        <input type="date" class="form-control" name="fecha_primera_sesion" required>
                                    </div>
                                </div>
                                <div class="mt-3" id="personalizada_warning" style="display: none;">
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle"></i>
                                        Al seleccionar "Fechas Personalizadas", podr√° elegir las fechas espec√≠ficas despu√©s de crear la orden.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Crear Orden
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Nuevo Paciente -->
    <div class="modal fade" id="nuevoPacienteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-person-plus"></i> Nuevo Paciente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="pacienteForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Nombre Completo *</label>
                            <input type="text" class="form-control" name="nombreCompleto" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">DNI *</label>
                            <input type="text" class="form-control" name="dni" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Obra Social *</label>
                            <select class="form-select" name="obraSocial_id" required>
                                <option value="">Seleccionar obra social...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">N√∫mero de Afiliado</label>
                            <input type="text" class="form-control" name="numeroAfiliado">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Crear Paciente
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Detalle de Orden -->
    <div class="modal fade" id="detalleOrdenModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-file-earmark-text"></i> Detalle de Orden</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detalleOrdenContent">
                    <!-- Se llena din√°micamente -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Fechas Personalizadas -->
    <div class="modal fade" id="fechasPersonalizadasModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-calendar3"></i> Seleccionar Fechas Personalizadas</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        Seleccione las fechas espec√≠ficas para cada sesi√≥n. La hora configurada se aplicar√° a todas las sesiones.
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Cantidad de Sesiones: <span id="totalSesionesCustom">0</span></label>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Hora de Sesiones</label>
                                <input type="time" class="form-control" id="horaPersonalizada" value="09:00" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="border-bottom pb-2">Seleccionar Fechas</h6>
                            <div class="mb-3">
                                <label class="form-label">Fecha</label>
                                <input type="date" class="form-control" id="fechaSesionCustom">
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="agregarFechaPersonalizada()">
                                <i class="bi bi-plus"></i> Agregar Fecha
                            </button>
                        </div>
                        <div class="col-md-6">
                            <h6 class="border-bottom pb-2">Fechas Seleccionadas</h6>
                            <div id="fechasSeleccionadas" class="list-group" style="max-height: 300px; overflow-y: auto;">
                                <!-- Se llenan din√°micamente -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <div class="alert alert-warning" id="warningFaltanFechas" style="display: none;">
                            <i class="bi bi-exclamation-triangle"></i>
                            Debe seleccionar <span id="faltanCuantas">0</span> fecha(s) m√°s.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="confirmarFechasPersonalizadas" disabled>
                        <i class="bi bi-check"></i> Confirmar Fechas
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/storage.js"></script>
    <script src="../js/data.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/app.js"></script>
    <script>
        // JavaScript espec√≠fico para la p√°gina de √≥rdenes
        document.addEventListener('DOMContentLoaded', function() {
            OrdenesPage.init();
        });

        const OrdenesPage = {
            init: function() {
                this.loadFilters();
                this.loadOrders();
                this.setupEventListeners();
                this.loadFormData();
            },

            loadFilters: function() {
                // Cargar obras sociales en filtros
                const obrasSociales = GestorOrdenes.storage.obrasSociales.getAll();
                const filtroOS = document.getElementById('filtroObraSocial');
                
                obrasSociales.forEach(os => {
                    const option = document.createElement('option');
                    option.value = os.id;
                    option.textContent = os.nombre;
                    filtroOS.appendChild(option);
                });

                // Cargar pr√°cticas en filtros
                const practicas = GestorOrdenes.storage.practicas.getAll();
                const filtroPractica = document.getElementById('filtroPractica');
                
                practicas.forEach(practica => {
                    const option = document.createElement('option');
                    option.value = practica.id;
                    option.textContent = practica.nombrePractica;
                    filtroPractica.appendChild(option);
                });
            },

            loadFormData: function() {
                // Cargar pacientes
                this.loadPacientes();
                
                // Cargar obras sociales
                this.loadObrasSociales();
                
                // Cargar m√©dicos derivantes
                this.loadMedicosDerivantes();
                
                // Cargar pr√°cticas
                this.loadPracticas();
                
                // Establecer fecha actual
                document.querySelector('[name="fechaEmision"]').value = GestorOrdenes.utils.getCurrentDate();
                
                // Establecer fecha de primera sesi√≥n por defecto (ma√±ana)
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                document.querySelector('[name="fecha_primera_sesion"]').value = tomorrow.toISOString().split('T')[0];
            },

            loadPacientes: function() {
                const pacientes = GestorOrdenes.storage.pacientes.getAll();
                const select = document.getElementById('pacienteSelect');
                
                // Limpiar opciones existentes excepto la primera
                select.innerHTML = '<option value="">Seleccionar paciente...</option>';
                
                pacientes.forEach(paciente => {
                    const option = document.createElement('option');
                    option.value = paciente.id;
                    option.textContent = `${paciente.nombreCompleto} - DNI: ${paciente.dni}`;
                    select.appendChild(option);
                });
            },

            loadObrasSociales: function() {
                const obrasSociales = GestorOrdenes.storage.obrasSociales.getAll();
                const selects = document.querySelectorAll('[name="obraSocial_id"]');
                
                selects.forEach(select => {
                    select.innerHTML = '<option value="">Seleccionar obra social...</option>';
                    obrasSociales.forEach(os => {
                        const option = document.createElement('option');
                        option.value = os.id;
                        option.textContent = os.nombre;
                        select.appendChild(option);
                    });
                });
            },

            loadMedicosDerivantes: function() {
                const medicos = GestorOrdenes.storage.medicos.getAll();
                const select = document.querySelector('[name="medicoDerivante_id"]');
                
                select.innerHTML = '<option value="">Seleccionar m√©dico...</option>';
                medicos.forEach(medico => {
                    const option = document.createElement('option');
                    option.value = medico.id;
                    option.textContent = `${medico.nombreCompleto} - ${medico.matricula}`;
                    select.appendChild(option);
                });
            },

            loadPracticas: function() {
                const practicas = GestorOrdenes.storage.practicas.getAll();
                const select = document.querySelector('[name="practica_id"]');
                
                select.innerHTML = '<option value="">Seleccionar pr√°ctica...</option>';
                practicas.forEach(practica => {
                    const option = document.createElement('option');
                    option.value = practica.id;
                    option.textContent = practica.nombrePractica;
                    select.appendChild(option);
                });
            },

            loadOrders: function() {
                let ordenes = GestorOrdenes.storage.ordenes.getAll();
                
                // Aplicar filtros si existen
                ordenes = this.applyFilters(ordenes);
                
                // Ordenar por fecha de emisi√≥n (m√°s recientes primero)
                ordenes.sort((a, b) => new Date(b.fechaEmision) - new Date(a.fechaEmision));
                
                const tbody = document.getElementById('ordenesTableBody');
                tbody.innerHTML = '';
                
                if (ordenes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center">No hay √≥rdenes que coincidan con los filtros</td></tr>';
                    return;
                }
                
                ordenes.forEach(orden => {
                    const row = this.createOrderRow(orden);
                    tbody.appendChild(row);
                });
            },

            createOrderRow: function(orden) {
                const paciente = GestorOrdenes.storage.pacientes.getById(orden.paciente_id);
                const obraSocial = GestorOrdenes.storage.obrasSociales.getById(orden.obraSocial_id);
                const practica = GestorOrdenes.storage.practicas.getById(orden.practica_id);
                const progreso = GestorOrdenes.utils.getSessionProgress(orden.id);
                
                // Calcular estado de programaci√≥n
                const estadoProgramacion = this.getOrderSchedulingStatus(orden);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="d-flex align-items-center">
                            <span class="order-status-icon ${estadoProgramacion.class}" title="${estadoProgramacion.descripcion}"></span>
                            ${estadoProgramacion.icono}
                        </div>
                    </td>
                    <td>
                        ${orden.id}
                        ${estadoProgramacion.tipo === 'sin_programar' ? 
                            `<button class="btn btn-sm btn-outline-danger ms-1" onclick="OrdenesPage.quickSchedule(${orden.id})" title="Programar ahora">
                                <i class="bi bi-calendar-plus"></i>
                            </button>` : ''
                        }
                    </td>
                    <td>${paciente ? paciente.nombreCompleto : 'N/A'}</td>
                    <td>${paciente ? paciente.dni : 'N/A'}</td>
                    <td>${obraSocial ? obraSocial.nombre : 'N/A'}</td>
                    <td class="text-truncate" style="max-width: 200px;" title="${practica ? practica.nombrePractica : 'N/A'}">
                        ${practica ? practica.nombrePractica : 'N/A'}
                    </td>
                    <td>${GestorOrdenes.utils.formatDate(orden.fechaEmision)}</td>
                    <td>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar" role="progressbar" style="width: ${progreso.porcentaje}%">
                                ${progreso.realizadas}/${progreso.total}
                            </div>
                        </div>
                        <small class="text-muted">${progreso.porcentaje}%</small>
                    </td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-primary" onclick="OrdenesPage.viewOrder(${orden.id})" title="Ver detalle">
                                <i class="bi bi-eye"></i>
                            </button>
                            ${orden.estado === 'Abierta' ? `
                                <button class="btn btn-sm btn-warning" onclick="OrdenesPage.closeOrder(${orden.id})" title="Cerrar orden">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                `;
                
                return row;
            },
            
            // Determinar estado de programaci√≥n de una orden
            getOrderSchedulingStatus: function(orden) {
                const sesiones = GestorOrdenes.storage.sesiones.getByOrden(orden.id);
                const sesionesSinProgramar = sesiones.filter(s => s.estado === 'Pendiente' && !s.fecha_programada);
                const sesionesConFecha = sesiones.filter(s => s.fecha_programada && s.hora_programada);
                
                // Verificar conflictos para sesiones programadas
                let tieneConflictos = false;
                if (sesionesConFecha.length > 0) {
                    const conflicts = GestorOrdenes.app.checkScheduleConflicts(sesionesConFecha);
                    tieneConflictos = conflicts.length > 0;
                }
                
                if (sesionesSinProgramar.length > 0) {
                    return {
                        tipo: 'sin_programar',
                        icono: 'üî¥',
                        class: 'status-sin-programar',
                        descripcion: `${sesionesSinProgramar.length} sesi√≥n(es) sin programar`
                    };
                } else if (tieneConflictos) {
                    return {
                        tipo: 'conflictos',
                        icono: '‚ö†Ô∏è',
                        class: 'status-conflicto',
                        descripcion: 'Conflictos de horario detectados'
                    };
                } else if (sesionesConFecha.length > 0) {
                    return {
                        tipo: 'programada',
                        icono: '‚úÖ',
                        class: 'status-programada',
                        descripcion: 'Todas las sesiones programadas'
                    };
                } else {
                    return {
                        tipo: 'parcial',
                        icono: 'üü°',
                        class: 'status-parcial',
                        descripcion: 'Programaci√≥n parcial'
                    };
                }
            },

            setupEventListeners: function() {
                // Filtros
                document.getElementById('aplicarFiltros').addEventListener('click', () => {
                    this.loadOrders();
                });
                
                document.getElementById('limpiarFiltros').addEventListener('click', () => {
                    this.clearFilters();
                    this.loadOrders();
                });
                
                // Formulario de paciente
                document.getElementById('pacienteForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handlePacienteSubmit(e.target);
                });
                
                // Formulario de orden
                document.getElementById('ordenForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleOrdenSubmit(e.target);
                });
                
                // Radio buttons de programaci√≥n
                document.querySelectorAll('[name="programacion_tipo"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        this.handleProgramacionChange(e.target.value);
                    });
                });
                
                // Validaci√≥n de fecha de primera sesi√≥n
                document.querySelector('[name="fecha_primera_sesion"]').addEventListener('change', (e) => {
                    this.validateFechaPrimeraSesion(e.target.value);
                });
                
                // Event listener para confirmar fechas personalizadas
                document.getElementById('confirmarFechasPersonalizadas').addEventListener('click', () => {
                    this.confirmarFechasPersonalizadas();
                });
                
                // Bot√≥n de programar pendientes
                document.getElementById('programarPendientes').addEventListener('click', () => {
                    this.programarOrdenesPendientes();
                });
            },

            applyFilters: function(ordenes) {
                const filters = {
                    estado: document.getElementById('filtroEstado').value,
                    estadoProgramacion: document.getElementById('filtroEstadoProgramacion').value,
                    paciente: document.getElementById('filtroPaciente').value,
                    obraSocial: parseInt(document.getElementById('filtroObraSocial').value) || null,
                    practica: parseInt(document.getElementById('filtroPractica').value) || null,
                    fechaDesde: document.getElementById('filtroFechaDesde').value,
                    fechaHasta: document.getElementById('filtroFechaHasta').value
                };
                
                // Aplicar filtro base
                let filteredOrders = GestorOrdenes.utils.filterOrders(ordenes, filters);
                
                // Aplicar filtro de estado de programaci√≥n
                if (filters.estadoProgramacion) {
                    filteredOrders = filteredOrders.filter(orden => {
                        const estadoProgramacion = this.getOrderSchedulingStatus(orden);
                        return estadoProgramacion.tipo === filters.estadoProgramacion;
                    });
                }
                
                return filteredOrders;
            },

            clearFilters: function() {
                document.getElementById('filtroEstado').value = '';
                document.getElementById('filtroEstadoProgramacion').value = '';
                document.getElementById('filtroPaciente').value = '';
                document.getElementById('filtroObraSocial').value = '';
                document.getElementById('filtroPractica').value = '';
                document.getElementById('filtroFechaDesde').value = '';
                document.getElementById('filtroFechaHasta').value = '';
            },

            handlePacienteSubmit: function(form) {
                try {
                    const formData = new FormData(form);
                    const pacienteData = {
                        nombreCompleto: formData.get('nombreCompleto'),
                        dni: formData.get('dni').replace(/[\s.-]/g, ''),
                        obraSocial_id: parseInt(formData.get('obraSocial_id')),
                        numeroAfiliado: formData.get('numeroAfiliado')
                    };
                    
                    // Validar DNI √∫nico
                    const existingPaciente = GestorOrdenes.storage.pacientes.getByDni(pacienteData.dni);
                    if (existingPaciente) {
                        GestorOrdenes.utils.showNotification('Ya existe un paciente con ese DNI', 'warning');
                        return;
                    }
                    
                    // Guardar paciente
                    const success = GestorOrdenes.storage.pacientes.save(pacienteData);
                    if (!success) {
                        throw new Error('Error al guardar el paciente');
                    }
                    
                    // Actualizar lista de pacientes
                    this.loadPacientes();
                    
                    // Seleccionar el nuevo paciente
                    document.getElementById('pacienteSelect').value = pacienteData.id;
                    
                    // Cerrar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('nuevoPacienteModal'));
                    modal.hide();
                    
                    // Limpiar formulario
                    form.reset();
                    
                    GestorOrdenes.utils.showNotification('Paciente creado exitosamente', 'success');
                    
                } catch (error) {
                    console.error('Error al crear paciente:', error);
                    GestorOrdenes.utils.showNotification('Error al crear el paciente', 'danger');
                }
            },

            viewOrder: function(ordenId) {
                const orden = GestorOrdenes.storage.ordenes.getById(ordenId);
                if (!orden) return;
                
                const paciente = GestorOrdenes.storage.pacientes.getById(orden.paciente_id);
                const obraSocial = GestorOrdenes.storage.obrasSociales.getById(orden.obraSocial_id);
                const practica = GestorOrdenes.storage.practicas.getById(orden.practica_id);
                const medicoDerivante = GestorOrdenes.storage.medicos.getById(orden.medicoDerivante_id);
                const sesiones = GestorOrdenes.storage.sesiones.getByOrden(ordenId);
                
                const content = document.getElementById('detalleOrdenContent');
                content.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Informaci√≥n de la Orden</h6>
                            <table class="table table-borderless">
                                <tr><td><strong>ID:</strong></td><td>${orden.id}</td></tr>
                                <tr><td><strong>Estado:</strong></td><td><span class="badge estado-${orden.estado.toLowerCase().replace(' ', '-')}">${orden.estado}</span></td></tr>
                                <tr><td><strong>Fecha Emisi√≥n:</strong></td><td>${GestorOrdenes.utils.formatDate(orden.fechaEmision)}</td></tr>
                                <tr><td><strong>Cantidad Total:</strong></td><td>${orden.cantidadSesionesTotal} sesiones</td></tr>
                                ${orden.fechaCierre ? `<tr><td><strong>Fecha Cierre:</strong></td><td>${GestorOrdenes.utils.formatDate(orden.fechaCierre)}</td></tr>` : ''}
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Informaci√≥n del Paciente</h6>
                            <table class="table table-borderless">
                                <tr><td><strong>Nombre:</strong></td><td>${paciente ? paciente.nombreCompleto : 'N/A'}</td></tr>
                                <tr><td><strong>DNI:</strong></td><td>${paciente ? paciente.dni : 'N/A'}</td></tr>
                                <tr><td><strong>Obra Social:</strong></td><td>${obraSocial ? obraSocial.nombre : 'N/A'}</td></tr>
                                <tr><td><strong>N¬∫ Afiliado:</strong></td><td>${paciente ? paciente.numeroAfiliado : 'N/A'}</td></tr>
                            </table>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <h6>Informaci√≥n del Tratamiento</h6>
                            <table class="table table-borderless">
                                <tr><td><strong>Pr√°ctica:</strong></td><td>${practica ? practica.nombrePractica : 'N/A'}</td></tr>
                                <tr><td><strong>C√≥digo:</strong></td><td>${practica ? practica.codigoInterno : 'N/A'}</td></tr>
                                <tr><td><strong>M√©dico Derivante:</strong></td><td>${medicoDerivante ? `${medicoDerivante.nombreCompleto} (${medicoDerivante.matricula})` : 'No especificado'}</td></tr>
                            </table>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <h6>Sesiones</h6>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Sesi√≥n</th>
                                            <th>Fecha</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${sesiones.map(sesion => `
                                            <tr>
                                                <td>${sesion.numeroSesion}</td>
                                                <td>${sesion.fechaPrestacion ? GestorOrdenes.utils.formatDate(sesion.fechaPrestacion) : '-'}</td>
                                                <td><span class="badge estado-${sesion.estado.toLowerCase()}">${sesion.estado}</span></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                
                const modal = new bootstrap.Modal(document.getElementById('detalleOrdenModal'));
                modal.show();
            },

            handleProgramacionChange: function(tipo) {
                const warning = document.getElementById('personalizada_warning');
                if (tipo === 'personalizada') {
                    warning.style.display = 'block';
                } else {
                    warning.style.display = 'none';
                }
            },
            
            validateFechaPrimeraSesion: function(fecha) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const selectedDate = new Date(fecha);
                selectedDate.setHours(0, 0, 0, 0);
                
                if (selectedDate < today) {
                    GestorOrdenes.utils.showNotification('La fecha de primera sesi√≥n no puede ser anterior a hoy', 'warning');
                    // Establecer fecha m√≠nima a ma√±ana
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    document.querySelector('[name="fecha_primera_sesion"]').value = tomorrow.toISOString().split('T')[0];
                    return false;
                }
                return true;
            },
            
            validateOrdenData: function(formData) {
                // Validaciones b√°sicas
                if (!formData.get('paciente_id')) {
                    GestorOrdenes.utils.showNotification('Debe seleccionar un paciente', 'warning');
                    return false;
                }
                
                if (!formData.get('obraSocial_id')) {
                    GestorOrdenes.utils.showNotification('Debe seleccionar una obra social', 'warning');
                    return false;
                }
                
                if (!formData.get('practica_id')) {
                    GestorOrdenes.utils.showNotification('Debe seleccionar una pr√°ctica', 'warning');
                    return false;
                }
                
                // Validar formato de hora
                const horaSesiones = formData.get('hora_sesiones');
                if (!horaSesiones || !/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/.test(horaSesiones)) {
                    GestorOrdenes.utils.showNotification('Formato de hora inv√°lido (HH:MM)', 'warning');
                    return false;
                }
                
                // Validar fecha de primera sesi√≥n
                const fechaPrimeraSesion = formData.get('fecha_primera_sesion');
                if (!this.validateFechaPrimeraSesion(fechaPrimeraSesion)) {
                    return false;
                }
                
                return true;
            },
            
            handleOrdenSubmit: async function(form) {
                try {
                    const formData = new FormData(form);
                    
                    // Validar datos
                    if (!this.validateOrdenData(formData)) {
                        return;
                    }
                    
                    const ordenData = {
                        profesional_id: 1, // Hardcoded for POC
                        paciente_id: parseInt(formData.get('paciente_id')),
                        obraSocial_id: parseInt(formData.get('obraSocial_id')),
                        medicoDerivante_id: formData.get('medicoDerivante_id') ? parseInt(formData.get('medicoDerivante_id')) : null,
                        practica_id: parseInt(formData.get('practica_id')),
                        fechaEmision: formData.get('fechaEmision'),
                        cantidadSesionesTotal: parseInt(formData.get('cantidadSesionesTotal')),
                        estado: 'Abierta',
                        fechaCierre: null,
                        // Campos de programaci√≥n
                        programacion_tipo: formData.get('programacion_tipo'),
                        hora_sesiones: formData.get('hora_sesiones'),
                        fecha_primera_sesion: formData.get('fecha_primera_sesion')
                    };
                    
                    console.log('Creando orden con datos:', ordenData);
                    
                    // Verificar si es programaci√≥n personalizada
                    if (ordenData.programacion_tipo === 'personalizada') {
                        // Guardar datos temporalmente y abrir modal de fechas personalizadas
                        this.tempOrdenData = ordenData;
                        this.abrirModalFechasPersonalizadas(ordenData);
                        return;
                    }
                    
                    // Guardar orden con manejo de conflictos para otros tipos
                    const success = await GestorOrdenes.app.createOrdenWithScheduling(ordenData, true);
                    
                    if (success === false) {
                        // Usuario decidi√≥ no continuar por conflictos
                        GestorOrdenes.utils.showNotification('Creaci√≥n de orden cancelada por conflictos de horario', 'info');
                        return;
                    }
                    
                    if (!success) {
                        throw new Error('Error al crear la orden');
                    }
                    
                    // Cerrar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('nuevaOrdenModal'));
                    modal.hide();
                    
                    // Limpiar formulario
                    form.reset();
                    
                    // Recargar lista
                    this.loadOrders();
                    
                    GestorOrdenes.utils.showNotification('Orden creada exitosamente con programaci√≥n autom√°tica', 'success');
                    
                } catch (error) {
                    console.error('Error al crear orden:', error);
                    GestorOrdenes.utils.showNotification('Error al crear la orden: ' + error.message, 'danger');
                }
            },

            closeOrder: function(ordenId) {
                GestorOrdenes.utils.showConfirmation('¬øEst√° seguro que desea cerrar esta orden manualmente?', () => {
                    const orden = GestorOrdenes.storage.ordenes.getById(ordenId);
                    if (orden) {
                        orden.estado = 'Cerrada Manual';
                        orden.fechaCierre = GestorOrdenes.utils.getCurrentDate();
                        GestorOrdenes.storage.ordenes.save(orden);
                        this.loadOrders();
                        GestorOrdenes.utils.showNotification('Orden cerrada exitosamente', 'success');
                    }
                });
            },
            
            // === FUNCIONES PARA FECHAS PERSONALIZADAS ===
            
            abrirModalFechasPersonalizadas: function(ordenData) {
                // Llenar datos del modal
                document.getElementById('totalSesionesCustom').textContent = ordenData.cantidadSesionesTotal;
                document.getElementById('horaPersonalizada').value = ordenData.hora_sesiones;
                
                // Limpiar fechas seleccionadas
                this.fechasSeleccionadasCustom = [];
                this.actualizarFechasSeleccionadas();
                
                // Establecer fecha m√≠nima (ma√±ana)
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                document.getElementById('fechaSesionCustom').min = tomorrow.toISOString().split('T')[0];
                
                // Abrir modal
                const modal = new bootstrap.Modal(document.getElementById('fechasPersonalizadasModal'));
                modal.show();
            },
            
            fechasSeleccionadasCustom: [],
            tempOrdenData: null,
            
            actualizarFechasSeleccionadas: function() {
                const container = document.getElementById('fechasSeleccionadas');
                const totalSesiones = parseInt(document.getElementById('totalSesionesCustom').textContent);
                const faltantes = totalSesiones - this.fechasSeleccionadasCustom.length;
                
                // Ordenar fechas
                this.fechasSeleccionadasCustom.sort((a, b) => new Date(a) - new Date(b));
                
                // Actualizar lista visual
                container.innerHTML = '';
                this.fechasSeleccionadasCustom.forEach((fecha, index) => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item d-flex justify-content-between align-items-center';
                    const fechaFormateada = new Date(fecha).toLocaleDateString('es-ES', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    item.innerHTML = `
                        <span><strong>Sesi√≥n ${index + 1}:</strong> ${fechaFormateada}</span>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="OrdenesPage.eliminarFechaPersonalizada('${fecha}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    `;
                    container.appendChild(item);
                });
                
                // Actualizar warning y bot√≥n
                const warning = document.getElementById('warningFaltanFechas');
                const btnConfirmar = document.getElementById('confirmarFechasPersonalizadas');
                
                if (faltantes > 0) {
                    warning.style.display = 'block';
                    document.getElementById('faltanCuantas').textContent = faltantes;
                    btnConfirmar.disabled = true;
                } else {
                    warning.style.display = 'none';
                    btnConfirmar.disabled = false;
                }
            },
            
            eliminarFechaPersonalizada: function(fecha) {
                this.fechasSeleccionadasCustom = this.fechasSeleccionadasCustom.filter(f => f !== fecha);
                this.actualizarFechasSeleccionadas();
            },
            
            confirmarFechasPersonalizadas: async function() {
                try {
                    if (!this.tempOrdenData || this.fechasSeleccionadasCustom.length === 0) {
                        return;
                    }
                    
                    // Crear sesiones personalizadas
                    const sesionesPersonalizadas = this.fechasSeleccionadasCustom.map((fecha, index) => ({
                        orden_id: null, // Se asignar√° despu√©s
                        numeroSesion: index + 1,
                        fecha_programada: fecha,
                        hora_programada: this.tempOrdenData.hora_sesiones,
                        fecha_real: null,
                        hora_real: null,
                        estado: 'Pendiente',
                        tipo_atencion: 'programada'
                    }));
                    
                    // Verificar conflictos
                    const conflicts = GestorOrdenes.app.checkScheduleConflicts(sesionesPersonalizadas);
                    
                    if (conflicts.length > 0) {
                        const continuar = await new Promise((resolve) => {
                            GestorOrdenes.app.showConflictResolutionModal(conflicts, resolve);
                        });
                        
                        if (!continuar) {
                            GestorOrdenes.utils.showNotification('Creaci√≥n cancelada por conflictos de horario', 'info');
                            return;
                        }
                    }
                    
                    // Guardar orden
                    const success = GestorOrdenes.storage.ordenes.save(this.tempOrdenData);
                    if (!success) {
                        throw new Error('Error al guardar la orden');
                    }
                    
                    // Asignar ID de orden a las sesiones y guardar
                    sesionesPersonalizadas.forEach(sesion => {
                        sesion.orden_id = this.tempOrdenData.id;
                    });
                    
                    const sessionSuccess = GestorOrdenes.storage.sesiones.bulkSave(sesionesPersonalizadas);
                    if (!sessionSuccess) {
                        throw new Error('Error al guardar las sesiones');
                    }
                    
                    // Cerrar modales
                    const modalFechas = bootstrap.Modal.getInstance(document.getElementById('fechasPersonalizadasModal'));
                    const modalOrden = bootstrap.Modal.getInstance(document.getElementById('nuevaOrdenModal'));
                    modalFechas.hide();
                    modalOrden.hide();
                    
                    // Limpiar
                    this.tempOrdenData = null;
                    this.fechasSeleccionadasCustom = [];
                    document.getElementById('ordenForm').reset();
                    
                    // Recargar
                    this.loadOrders();
                    
                    GestorOrdenes.utils.showNotification('Orden creada exitosamente con fechas personalizadas', 'success');
                    
                } catch (error) {
                    console.error('Error al confirmar fechas personalizadas:', error);
                    GestorOrdenes.utils.showNotification('Error al crear la orden: ' + error.message, 'danger');
                }
            },
            
            // === FUNCIONES PARA PROGRAMACI√ìN R√ÅPIDA (HU-1.2) ===
            
            // Programaci√≥n r√°pida de una orden individual
            quickSchedule: function(ordenId) {
                const orden = GestorOrdenes.storage.ordenes.getById(ordenId);
                if (!orden) {
                    GestorOrdenes.utils.showNotification('Orden no encontrada', 'error');
                    return;
                }
                
                const paciente = GestorOrdenes.storage.pacientes.getById(orden.paciente_id);
                const mensaje = `¬øProgramar autom√°ticamente las sesiones pendientes de ${paciente ? paciente.nombreCompleto : 'la orden #' + ordenId}?`;
                
                GestorOrdenes.utils.showConfirmation(mensaje, () => {
                    this.programarOrdenAuto(orden);
                });
            },
            
            // Programar m√∫ltiples √≥rdenes pendientes
            programarOrdenesPendientes: function() {
                const ordenes = GestorOrdenes.storage.ordenes.getActivas();
                const ordenesSinProgramar = ordenes.filter(orden => {
                    const estado = this.getOrderSchedulingStatus(orden);
                    return estado.tipo === 'sin_programar';
                });
                
                if (ordenesSinProgramar.length === 0) {
                    GestorOrdenes.utils.showNotification('No hay √≥rdenes pendientes de programar', 'info');
                    return;
                }
                
                const mensaje = `¬øProgramar autom√°ticamente ${ordenesSinProgramar.length} orden(es) pendiente(s)?`;
                GestorOrdenes.utils.showConfirmation(mensaje, () => {
                    this.programarMultiplesOrdenes(ordenesSinProgramar);
                });
            },
            
            // Programar una orden autom√°ticamente con configuraci√≥n por defecto
            programarOrdenAuto: function(orden) {
                try {
                    // Configuraci√≥n por defecto para programaci√≥n autom√°tica
                    const ordenConProgramacion = {
                        ...orden,
                        programacion_tipo: 'habiles',
                        hora_sesiones: '14:00',
                        fecha_primera_sesion: this.getNextBusinessDay()
                    };
                    
                    // Generar sesiones autom√°ticamente
                    const sesiones = GestorOrdenes.app.generateAutomaticSchedule(ordenConProgramacion);
                    
                    if (sesiones.length > 0) {
                        // Verificar conflictos
                        const conflicts = GestorOrdenes.app.checkScheduleConflicts(sesiones);
                        
                        if (conflicts.length > 0) {
                            const continuar = confirm(`Se detectaron ${conflicts.length} conflicto(s) de horario. ¬øContinuar de todas formas?`);
                            if (!continuar) {
                                return;
                            }
                        }
                        
                        // Guardar sesiones
                        const success = GestorOrdenes.storage.sesiones.bulkSave(sesiones);
                        if (success) {
                            GestorOrdenes.utils.showNotification('Orden programada exitosamente', 'success');
                            this.loadOrders();
                        } else {
                            throw new Error('Error al guardar las sesiones');
                        }
                    } else {
                        throw new Error('No se pudieron generar sesiones');
                    }
                    
                } catch (error) {
                    console.error('Error en programaci√≥n autom√°tica:', error);
                    GestorOrdenes.utils.showNotification('Error al programar la orden: ' + error.message, 'danger');
                }
            },
            
            // Programar m√∫ltiples √≥rdenes en lote
            programarMultiplesOrdenes: function(ordenes) {
                let exitosas = 0;
                let errores = 0;
                
                ordenes.forEach((orden, index) => {
                    try {
                        // Escalonar horarios para evitar conflictos
                        const hora = this.calculateStaggeredTime('14:00', index);
                        const fechaInicio = this.getNextBusinessDay(index);
                        
                        const ordenConProgramacion = {
                            ...orden,
                            programacion_tipo: 'habiles',
                            hora_sesiones: hora,
                            fecha_primera_sesion: fechaInicio
                        };
                        
                        const sesiones = GestorOrdenes.app.generateAutomaticSchedule(ordenConProgramacion);
                        
                        if (sesiones.length > 0) {
                            const success = GestorOrdenes.storage.sesiones.bulkSave(sesiones);
                            if (success) {
                                exitosas++;
                            } else {
                                errores++;
                            }
                        } else {
                            errores++;
                        }
                        
                    } catch (error) {
                        console.error(`Error al programar orden ${orden.id}:`, error);
                        errores++;
                    }
                });
                
                // Mostrar resultado
                if (exitosas > 0) {
                    GestorOrdenes.utils.showNotification(`${exitosas} orden(es) programada(s) exitosamente`, 'success');
                }
                if (errores > 0) {
                    GestorOrdenes.utils.showNotification(`${errores} orden(es) con errores`, 'warning');
                }
                
                this.loadOrders();
            },
            
            // Obtener siguiente d√≠a h√°bil
            getNextBusinessDay: function(dayOffset = 0) {
                const date = new Date();
                date.setDate(date.getDate() + 1 + dayOffset); // Empezar desde ma√±ana
                
                // Si cae en fin de semana, mover al lunes
                while (date.getDay() === 0 || date.getDay() === 6) {
                    date.setDate(date.getDate() + 1);
                }
                
                return date.toISOString().split('T')[0];
            },
            
            // Calcular horario escalonado para evitar conflictos
            calculateStaggeredTime: function(baseTime, index) {
                const [hours, minutes] = baseTime.split(':').map(Number);
                const totalMinutes = hours * 60 + minutes + (index * 60); // 1 hora de diferencia
                
                const newHours = Math.floor(totalMinutes / 60) % 24;
                const newMinutes = totalMinutes % 60;
                
                return `${String(newHours).padStart(2, '0')}:${String(newMinutes).padStart(2, '0')}`;
            }
        };
        
        // Funci√≥n global para agregar fecha personalizada
        window.agregarFechaPersonalizada = function() {
            const fechaInput = document.getElementById('fechaSesionCustom');
            const fecha = fechaInput.value;
            
            if (!fecha) {
                GestorOrdenes.utils.showNotification('Debe seleccionar una fecha', 'warning');
                return;
            }
            
            // Verificar que no sea fecha pasada
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const selectedDate = new Date(fecha);
            selectedDate.setHours(0, 0, 0, 0);
            
            if (selectedDate <= today) {
                GestorOrdenes.utils.showNotification('La fecha debe ser posterior a hoy', 'warning');
                return;
            }
            
            // Verificar que no est√© duplicada
            if (OrdenesPage.fechasSeleccionadasCustom.includes(fecha)) {
                GestorOrdenes.utils.showNotification('Esta fecha ya fue seleccionada', 'warning');
                return;
            }
            
            // Verificar que no exceda el l√≠mite
            const totalSesiones = parseInt(document.getElementById('totalSesionesCustom').textContent);
            if (OrdenesPage.fechasSeleccionadasCustom.length >= totalSesiones) {
                GestorOrdenes.utils.showNotification('Ya se alcanz√≥ el n√∫mero m√°ximo de sesiones', 'warning');
                return;
            }
            
            // Agregar fecha
            OrdenesPage.fechasSeleccionadasCustom.push(fecha);
            OrdenesPage.actualizarFechasSeleccionadas();
            
            // Limpiar input
            fechaInput.value = '';
        };
    </script>
</body>
</html>