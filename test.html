<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test POC - Gestor de √ìrdenes</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin-bottom: 30px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background-color: #0056b3; }
        .log { background-color: #f8f9fa; border: 1px solid #e9ecef; padding: 10px; border-radius: 4px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test POC - Gestor de √ìrdenes</h1>
        
        <div class="test-section info">
            <h3>üìä Estado del Sistema</h3>
            <p><strong>Status:</strong> <span id="systemStatus">Cargando...</span></p>
            <p><strong>M√≥dulos:</strong> <span id="modulesStatus">Verificando...</span></p>
            <p><strong>Datos:</strong> <span id="dataStatus">Verificando...</span></p>
        </div>

        <div class="test-section">
            <h3>üéÆ Pruebas Autom√°ticas</h3>
            <button onclick="runAllTests()">Ejecutar Todas las Pruebas</button>
            <button onclick="resetData()">Resetear Datos</button>
            <button onclick="forceUpdateData()">Actualizar Datos (Fix Ana Sof√≠a)</button>
            <button onclick="clearLog()">Limpiar Log</button>
        </div>

        <div class="test-section">
            <h3>üîç Pruebas Manuales R√°pidas</h3>
            <button onclick="testSearch()">Buscar Paciente DNI: 12345678</button>
            <button onclick="testCreateOrder()">Crear Orden de Prueba</button>
            <button onclick="testRegisterSession()">Registrar Sesi√≥n</button>
            <button onclick="testGenerateBilling()">Generar Presentaci√≥n</button>
        </div>

        <div class="test-section">
            <h3>üìÖ Pruebas de Programaci√≥n Autom√°tica (HU-1.1)</h3>
            <button onclick="testSchedulingBusinessDays()">Test: D√≠as H√°biles</button>
            <button onclick="testSchedulingMWF()">Test: Lunes-Mi√©rcoles-Viernes</button>
            <button onclick="testSchedulingTT()">Test: Martes-Jueves</button>
            <button onclick="testConflictDetection()">Test: Detecci√≥n de Conflictos</button>
            <button onclick="testCustomDates()">Test: Fechas Personalizadas</button>
            <button onclick="testAllSchedulingCases()">Ejecutar Todos los Tests de Programaci√≥n</button>
        </div>

        <div class="test-section">
            <h3>üîî Pruebas de Notificaciones (HU-1.2)</h3>
            <button onclick="testNotificationDetectors()">Test: Detectores de Notificaciones</button>
            <button onclick="testUnscheduledOrders()">Test: √ìrdenes Sin Programar</button>
            <button onclick="testScheduleConflicts()">Test: Conflictos de Horario</button>
            <button onclick="testNotificationCleanup()">Test: Limpieza de Notificaciones</button>
            <button onclick="testAllNotifications()">Ejecutar Todos los Tests de Notificaciones</button>
        </div>

        <div class="test-section">
            <h3>üìÖ Pruebas de Capacidad y Agenda (HU-1.3)</h3>
            <button onclick="testCapacityCalculation()">Test: C√°lculo de Capacidad</button>
            <button onclick="testCapacityWarnings()">Test: Advertencias de Capacidad</button>
            <button onclick="testAgendaViews()">Test: Vistas de Agenda</button>
            <button onclick="testTimeSlotDetails()">Test: Detalles de Horarios</button>
            <button onclick="testAllCapacity()">Ejecutar Todos los Tests de Capacidad</button>
        </div>

        <div class="test-section">
            <h3>üè† Pruebas de Dashboard Diario (HU-2.1)</h3>
            <button onclick="testTodayStats()">Test: Estad√≠sticas del D√≠a</button>
            <button onclick="testTodayAppointments()">Test: Citas de Hoy</button>
            <button onclick="testDashboardRefresh()">Test: Actualizaci√≥n Dashboard</button>
            <button onclick="testAllDashboard()">Ejecutar Todos los Tests de Dashboard</button>
        </div>

        <div class="test-section">
            <h3>‚úÖ Pruebas de Check-in Inteligente (HU-2.2)</h3>
            <button onclick="testTimingValidation()">Test: Validaci√≥n de Horarios</button>
            <button onclick="testEarlyPatient()">Test: Paciente Temprano</button>
            <button onclick="testLatePatient()">Test: Paciente Tard√≠o</button>
            <button onclick="testNoAppointment()">Test: Sin Cita Programada</button>
            <button onclick="testTimingModals()">Test: Modales de Confirmaci√≥n</button>
            <button onclick="testAllCheckin()">Ejecutar Todos los Tests de Check-in</button>
        </div>

        <div class="test-section">
            <h3>üìä Estad√≠sticas del Sistema</h3>
            <div id="stats"></div>
            <div id="todayStats" style="margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 4px;"></div>
        </div>

        <div class="test-section">
            <h3>üìù Log de Pruebas</h3>
            <div id="testLog" class="log"></div>
        </div>
    </div>

    <script src="js/storage.js"></script>
    <script src="js/data.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/app.js"></script>
    <script src="js/agenda.js"></script>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'blue';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }

        function checkSystemStatus() {
            try {
                // Verificar m√≥dulos incluyendo los nuevos
                const modules = ['storage', 'data', 'utils', 'app', 'ui', 'agenda'];
                const loadedModules = modules.filter(mod => GestorOrdenes[mod]);
                
                document.getElementById('systemStatus').textContent = 
                    GestorOrdenes ? 'Activo ‚úÖ' : 'Error ‚ùå';
                
                document.getElementById('modulesStatus').textContent = 
                    `${loadedModules.length}/${modules.length} cargados (${loadedModules.join(', ')})`;
                
                // Verificar datos
                const pacientes = GestorOrdenes.storage.pacientes.getAll();
                const ordenes = GestorOrdenes.storage.ordenes.getAll();
                const sesiones = GestorOrdenes.storage.sesiones.getAll();
                
                document.getElementById('dataStatus').textContent = 
                    `${pacientes.length} pacientes, ${ordenes.length} √≥rdenes, ${sesiones.length} sesiones`;
                
                updateStats();
                log('Sistema verificado correctamente', 'success');
                
            } catch (error) {
                log('Error al verificar sistema: ' + error.message, 'error');
            }
        }

        function updateStats() {
            const stats = GestorOrdenes.utils.getGeneralStats();
            document.getElementById('stats').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    <div><strong>√ìrdenes Activas:</strong> ${stats.ordenesActivas}</div>
                    <div><strong>Sesiones Realizadas:</strong> ${stats.sesionesRealizadas}</div>
                    <div><strong>Sesiones Pendientes:</strong> ${stats.sesionesPendientes}</div>
                    <div><strong>Presentaciones:</strong> ${stats.presentaciones || 0}</div>
                </div>
            `;
            
            // Agregar estad√≠sticas del d√≠a actual
            try {
                const todayStats = GestorOrdenes.utils.getTodayStats();
                document.getElementById('todayStats').innerHTML = `
                    <h6>üìÖ Estad√≠sticas de Hoy:</h6>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                        <div><strong>Programadas:</strong> ${todayStats.programadas}</div>
                        <div><strong>Completadas:</strong> ${todayStats.completadas}</div>
                        <div><strong>Progreso:</strong> ${todayStats.porcentaje}%</div>
                    </div>
                    <div style="margin-top: 5px;">
                        <strong>Pr√≥xima Cita:</strong> ${todayStats.proximaCita.hora || '--:--'} 
                        ${todayStats.proximaCita.paciente ? '(' + todayStats.proximaCita.paciente + ')' : ''}
                    </div>
                `;
            } catch (error) {
                document.getElementById('todayStats').innerHTML = '<div>Error al cargar estad√≠sticas del d√≠a</div>';
            }
        }

        function testSearch() {
            try {
                const paciente = GestorOrdenes.app.searchPatientByDni('12345678');
                if (paciente) {
                    log(`‚úÖ Paciente encontrado: ${paciente.nombreCompleto}`, 'success');
                    const ordenes = GestorOrdenes.app.getActiveOrdersForPatient(paciente.id);
                    log(`üìã √ìrdenes activas: ${ordenes.length}`, 'info');
                } else {
                    log('‚ùå Paciente no encontrado', 'error');
                }
            } catch (error) {
                log('Error en b√∫squeda: ' + error.message, 'error');
            }
        }

        function testCreateOrder() {
            try {
                const ordenData = {
                    profesional_id: 1,
                    paciente_id: 1,
                    obraSocial_id: 1,
                    medicoDerivante_id: 1,
                    practica_id: 1,
                    fechaEmision: GestorOrdenes.utils.getCurrentDate(),
                    cantidadSesionesTotal: 5,
                    estado: 'Abierta',
                    fechaCierre: null
                };

                const success = GestorOrdenes.storage.ordenes.save(ordenData);
                if (success) {
                    GestorOrdenes.app.createSessionsForOrder(ordenData);
                    log(`‚úÖ Orden creada: ID ${ordenData.id}`, 'success');
                    updateStats();
                } else {
                    log('‚ùå Error al crear orden', 'error');
                }
            } catch (error) {
                log('Error al crear orden: ' + error.message, 'error');
            }
        }

        function testRegisterSession() {
            try {
                const ordenes = GestorOrdenes.storage.ordenes.getActivas();
                if (ordenes.length > 0) {
                    const success = GestorOrdenes.app.registerTodaySession(ordenes[0].id);
                    if (success) {
                        log('‚úÖ Sesi√≥n registrada exitosamente', 'success');
                        updateStats();
                    } else {
                        log('‚ùå Error al registrar sesi√≥n', 'error');
                    }
                } else {
                    log('‚ùå No hay √≥rdenes activas', 'error');
                }
            } catch (error) {
                log('Error al registrar sesi√≥n: ' + error.message, 'error');
            }
        }

        function testGenerateBilling() {
            try {
                const currentDate = new Date();
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth() + 1;
                
                const billingResult = GestorOrdenes.app.generateBilling(year, month);
                if (billingResult) {
                    log(`‚úÖ Presentaci√≥n generada: ${billingResult.billingData.length} obra(s) social(es)`, 'success');
                    log(`üí∞ Total: $${billingResult.presentacion.importeTotal}`, 'info');
                    updateStats();
                } else {
                    log('‚ùå No hay datos para presentar', 'error');
                }
            } catch (error) {
                log('Error al generar presentaci√≥n: ' + error.message, 'error');
            }
        }

        function resetData() {
            try {
                GestorOrdenes.data.reset();
                log('‚úÖ Datos reseteados correctamente', 'success');
                updateStats();
            } catch (error) {
                log('Error al resetear datos: ' + error.message, 'error');
            }
        }

        function forceUpdateData() {
            try {
                GestorOrdenes.data.forceUpdate();
                log('‚úÖ Datos actualizados forzosamente - Conflictos y capacidad agregados', 'success');
                
                // Verificar espec√≠ficamente la orden de Ana Sof√≠a
                setTimeout(() => {
                    const orden3 = GestorOrdenes.storage.ordenes.getById(3);
                    const sesionesOrden3 = GestorOrdenes.storage.sesiones.getByOrden(3);
                    const progreso = GestorOrdenes.utils.getSessionProgress(3);
                    
                    log(`üìä Orden ID 3: ${orden3 ? orden3.cantidadSesionesTotal : 'NO ENCONTRADA'} sesiones totales`, 'info');
                    log(`üìä Sesiones encontradas: ${sesionesOrden3.length}`, 'info');
                    log(`üìä Progreso: ${progreso.realizadas}/${progreso.total} (${progreso.porcentaje}%)`, 'info');
                    
                    if (orden3 && orden3.cantidadSesionesTotal === 10 && sesionesOrden3.length === 10) {
                        log('üéâ ¬°√âXITO! Ana Sof√≠a Mart√≠nez tiene los datos correctos', 'success');
                    } else {
                        log('‚ùå PROBLEMA: Los datos siguen incorrectos', 'error');
                    }
                    
                    updateStats();
                }, 500);
                
            } catch (error) {
                log('Error al actualizar datos: ' + error.message, 'error');
            }
        }

        // === NUEVAS FUNCIONES DE TEST PARA PROGRAMACI√ìN AUTOM√ÅTICA ===
        
        function testSchedulingBusinessDays() {
            try {
                log('üß™ Test: Programaci√≥n d√≠as h√°biles...', 'info');
                
                const ordenData = {
                    id: 9999, // ID temporal para testing
                    profesional_id: 1,
                    paciente_id: 1,
                    obraSocial_id: 1,
                    medicoDerivante_id: 1,
                    practica_id: 1,
                    fechaEmision: '2025-07-16',
                    cantidadSesionesTotal: 5,
                    estado: 'Abierta',
                    fechaCierre: null,
                    programacion_tipo: 'habiles',
                    hora_sesiones: '14:00',
                    fecha_primera_sesion: '2025-07-17' // Jueves
                };
                
                const sesiones = GestorOrdenes.app.generateAutomaticSchedule(ordenData);
                
                if (sesiones.length === 5) {
                    log(`‚úÖ Generadas ${sesiones.length} sesiones para d√≠as h√°biles`, 'success');
                    sesiones.forEach((sesion, index) => {
                        const fecha = new Date(sesion.fecha_programada);
                        const dia = fecha.toLocaleDateString('es-ES', { weekday: 'long' });
                        log(`  Sesi√≥n ${index + 1}: ${sesion.fecha_programada} (${dia}) a las ${sesion.hora_programada}`, 'info');
                    });
                    
                    // Verificar que todos son d√≠as h√°biles (lunes a viernes)
                    const allBusinessDays = sesiones.every(sesion => {
                        const fecha = new Date(sesion.fecha_programada);
                        const dayOfWeek = fecha.getDay();
                        return dayOfWeek >= 1 && dayOfWeek <= 5;
                    });
                    
                    if (allBusinessDays) {
                        log('‚úÖ Todas las sesiones son en d√≠as h√°biles', 'success');
                    } else {
                        log('‚ùå ERROR: Algunas sesiones no son en d√≠as h√°biles', 'error');
                    }
                } else {
                    log(`‚ùå ERROR: Se esperaban 5 sesiones, se generaron ${sesiones.length}`, 'error');
                }
                
            } catch (error) {
                log('Error en test d√≠as h√°biles: ' + error.message, 'error');
            }
        }
        
        function testSchedulingMWF() {
            try {
                log('üß™ Test: Programaci√≥n Lunes-Mi√©rcoles-Viernes...', 'info');
                
                const ordenData = {
                    id: 9998,
                    profesional_id: 1,
                    paciente_id: 2,
                    obraSocial_id: 2,
                    medicoDerivante_id: 2,
                    practica_id: 2,
                    fechaEmision: '2025-07-16',
                    cantidadSesionesTotal: 6,
                    estado: 'Abierta',
                    fechaCierre: null,
                    programacion_tipo: 'lmv',
                    hora_sesiones: '10:00',
                    fecha_primera_sesion: '2025-07-21' // Lunes
                };
                
                const sesiones = GestorOrdenes.app.generateAutomaticSchedule(ordenData);
                
                if (sesiones.length === 6) {
                    log(`‚úÖ Generadas ${sesiones.length} sesiones para LMV`, 'success');
                    sesiones.forEach((sesion, index) => {
                        const fecha = new Date(sesion.fecha_programada);
                        const dia = fecha.toLocaleDateString('es-ES', { weekday: 'long' });
                        log(`  Sesi√≥n ${index + 1}: ${sesion.fecha_programada} (${dia}) a las ${sesion.hora_programada}`, 'info');
                    });
                    
                    // Verificar que todos son L, M, V (1, 3, 5)
                    const allMWF = sesiones.every(sesion => {
                        const fecha = new Date(sesion.fecha_programada);
                        const dayOfWeek = fecha.getDay();
                        return dayOfWeek === 1 || dayOfWeek === 3 || dayOfWeek === 5;
                    });
                    
                    if (allMWF) {
                        log('‚úÖ Todas las sesiones son en Lunes, Mi√©rcoles o Viernes', 'success');
                    } else {
                        log('‚ùå ERROR: Algunas sesiones no est√°n en LMV', 'error');
                    }
                } else {
                    log(`‚ùå ERROR: Se esperaban 6 sesiones, se generaron ${sesiones.length}`, 'error');
                }
                
            } catch (error) {
                log('Error en test LMV: ' + error.message, 'error');
            }
        }
        
        function testSchedulingTT() {
            try {
                log('üß™ Test: Programaci√≥n Martes-Jueves...', 'info');
                
                const ordenData = {
                    id: 9997,
                    profesional_id: 1,
                    paciente_id: 3,
                    obraSocial_id: 3,
                    medicoDerivante_id: 3,
                    practica_id: 3,
                    fechaEmision: '2025-07-16',
                    cantidadSesionesTotal: 4,
                    estado: 'Abierta',
                    fechaCierre: null,
                    programacion_tipo: 'mtj',
                    hora_sesiones: '16:00',
                    fecha_primera_sesion: '2025-07-22' // Martes
                };
                
                const sesiones = GestorOrdenes.app.generateAutomaticSchedule(ordenData);
                
                if (sesiones.length === 4) {
                    log(`‚úÖ Generadas ${sesiones.length} sesiones para MTJ`, 'success');
                    sesiones.forEach((sesion, index) => {
                        const fecha = new Date(sesion.fecha_programada);
                        const dia = fecha.toLocaleDateString('es-ES', { weekday: 'long' });
                        log(`  Sesi√≥n ${index + 1}: ${sesion.fecha_programada} (${dia}) a las ${sesion.hora_programada}`, 'info');
                    });
                    
                    // Verificar que todos son M, J (2, 4)
                    const allTT = sesiones.every(sesion => {
                        const fecha = new Date(sesion.fecha_programada);
                        const dayOfWeek = fecha.getDay();
                        return dayOfWeek === 2 || dayOfWeek === 4;
                    });
                    
                    if (allTT) {
                        log('‚úÖ Todas las sesiones son en Martes o Jueves', 'success');
                    } else {
                        log('‚ùå ERROR: Algunas sesiones no est√°n en MTJ', 'error');
                    }
                } else {
                    log(`‚ùå ERROR: Se esperaban 4 sesiones, se generaron ${sesiones.length}`, 'error');
                }
                
            } catch (error) {
                log('Error en test MTJ: ' + error.message, 'error');
            }
        }
        
        function testConflictDetection() {
            try {
                log('üß™ Test: Detecci√≥n de conflictos...', 'info');
                
                // Crear sesiones que deliberadamente tienen conflictos
                const sesionExistente = {
                    id: 1000,
                    orden_id: 1,
                    numeroSesion: 1,
                    fecha_programada: '2025-07-17',
                    hora_programada: '14:00'
                };
                
                // Guardar la sesi√≥n existente temporalmente
                GestorOrdenes.storage.sesiones.save(sesionExistente);
                
                const nuevasSesiones = [
                    {
                        orden_id: 2,
                        numeroSesion: 1,
                        fecha_programada: '2025-07-17',
                        hora_programada: '14:00' // CONFLICTO
                    },
                    {
                        orden_id: 2,
                        numeroSesion: 2,
                        fecha_programada: '2025-07-18',
                        hora_programada: '10:00' // SIN CONFLICTO
                    }
                ];
                
                const conflicts = GestorOrdenes.app.checkScheduleConflicts(nuevasSesiones);
                
                if (conflicts.length === 1) {
                    log(`‚úÖ Detectado ${conflicts.length} conflicto correctamente`, 'success');
                    log(`  Conflicto en: ${conflicts[0].conflictDate} a las ${conflicts[0].conflictTime}`, 'info');
                } else {
                    log(`‚ùå ERROR: Se esperaba 1 conflicto, se detectaron ${conflicts.length}`, 'error');
                }
                
                // Limpiar la sesi√≥n temporal
                const allSessions = GestorOrdenes.storage.sesiones.getAll();
                const filtered = allSessions.filter(s => s.id !== 1000);
                GestorOrdenes.storage.set('SESIONES', filtered);
                
            } catch (error) {
                log('Error en test de conflictos: ' + error.message, 'error');
            }
        }
        
        function testAllSchedulingCases() {
            log('üöÄ Ejecutando todos los tests de programaci√≥n autom√°tica...', 'info');
            
            setTimeout(() => testSchedulingBusinessDays(), 100);
            setTimeout(() => testSchedulingMWF(), 500);
            setTimeout(() => testSchedulingTT(), 900);
            setTimeout(() => testConflictDetection(), 1300);
            setTimeout(() => testCustomDates(), 1700);
            setTimeout(() => {
                log('‚úÖ Tests de programaci√≥n autom√°tica completados', 'success');
            }, 2100);
        }

        // === NUEVAS FUNCIONES DE TEST PARA HU-1.2 (NOTIFICACIONES) ===
        
        function testNotificationDetectors() {
            try {
                log('üß™ Test: Detectores de notificaciones...', 'info');
                
                // Ejecutar detectores
                const unscheduled = GestorOrdenes.app.detectUnscheduledOrders();
                const conflicts = GestorOrdenes.app.detectScheduleConflicts();
                const upcoming = GestorOrdenes.app.detectUpcomingAppointments();
                
                log(`‚úÖ √ìrdenes sin programar: ${unscheduled.length} notificaciones`, 'success');
                log(`‚úÖ Conflictos detectados: ${conflicts.length} notificaciones`, 'success');
                log(`‚úÖ Citas pr√≥ximas: ${upcoming.length} notificaciones`, 'success');
                
                const totalNotifications = GestorOrdenes.storage.notificaciones.getUnread().length;
                log(`üìä Total notificaciones no le√≠das: ${totalNotifications}`, 'info');
                
            } catch (error) {
                log('Error en test de detectores: ' + error.message, 'error');
            }
        }
        
        function testUnscheduledOrders() {
            try {
                log('üß™ Test: √ìrdenes sin programar...', 'info');
                
                // Crear orden temporal sin sesiones programadas
                const testOrder = {
                    id: 9995,
                    profesional_id: 1,
                    paciente_id: 1,
                    estado: 'Abierta',
                    cantidadSesionesTotal: 3
                };
                
                GestorOrdenes.storage.ordenes.save(testOrder);
                
                // Crear sesiones sin fecha programada
                for (let i = 1; i <= 3; i++) {
                    GestorOrdenes.storage.sesiones.save({
                        orden_id: 9995,
                        numeroSesion: i,
                        estado: 'Pendiente',
                        fecha_programada: null,
                        hora_programada: null
                    });
                }
                
                const result = GestorOrdenes.app.detectUnscheduledOrders();
                
                if (result.length > 0) {
                    log(`‚úÖ Detectada orden sin programar: ${result.length} notificaciones`, 'success');
                } else {
                    log('‚ùå No se detectaron √≥rdenes sin programar', 'error');
                }
                
                // Limpiar datos de prueba
                const ordenes = GestorOrdenes.storage.ordenes.getAll().filter(o => o.id !== 9995);
                const sesiones = GestorOrdenes.storage.sesiones.getAll().filter(s => s.orden_id !== 9995);
                GestorOrdenes.storage.set('ORDENES', ordenes);
                GestorOrdenes.storage.set('SESIONES', sesiones);
                
            } catch (error) {
                log('Error en test √≥rdenes sin programar: ' + error.message, 'error');
            }
        }

        // === FUNCIONES DE TEST PARA HU-1.3 (CAPACIDAD) ===
        
        function testCapacityCalculation() {
            try {
                log('üß™ Test: C√°lculo de capacidad...', 'info');
                
                // Test para hoy 16/7/2025 a las 11:00 (deber√≠a tener 3 pacientes)
                const today = new Date('2025-07-16');
                const capacity = GestorOrdenes.agenda.getCapacityByTimeSlot(today, 11);
                
                log(`üìä Capacidad 11:00 hoy: ${capacity.count} pacientes`, 'info');
                log(`üìä Nivel: ${capacity.level}`, 'info');
                
                if (capacity.count >= 3) {
                    log('‚úÖ Capacidad media/alta detectada correctamente', 'success');
                } else {
                    log('‚ùå No se detect√≥ la capacidad esperada', 'error');
                }
                
                capacity.patients.forEach((patient, index) => {
                    log(`  ${index + 1}. ${patient.nombre} - ${patient.practica}`, 'info');
                });
                
            } catch (error) {
                log('Error en test de capacidad: ' + error.message, 'error');
            }
        }
        
        function testAgendaViews() {
            try {
                log('üß™ Test: Vistas de agenda...', 'info');
                
                // Simular que el m√≥dulo de agenda est√° disponible
                if (typeof GestorOrdenes.agenda !== 'undefined') {
                    log('‚úÖ M√≥dulo de agenda cargado', 'success');
                    
                    // Test vista diaria
                    const today = new Date();
                    log(`üìÖ Vista diaria para: ${today.toLocaleDateString()}`, 'info');
                    
                    // Test vista semanal
                    log('üìÖ Vista semanal disponible', 'info');
                    
                } else {
                    log('‚ö†Ô∏è M√≥dulo de agenda no disponible (normal en test.html)', 'info');
                }
                
            } catch (error) {
                log('Error en test de vistas: ' + error.message, 'error');
            }
        }

        // === FUNCIONES DE TEST PARA HU-2.1 (DASHBOARD) ===
        
        function testTodayStats() {
            try {
                log('üß™ Test: Estad√≠sticas del d√≠a...', 'info');
                
                const stats = GestorOrdenes.utils.getTodayStats();
                
                log(`üìä Citas programadas hoy: ${stats.programadas}`, 'info');
                log(`üìä Citas completadas: ${stats.completadas}`, 'info');
                log(`üìä Porcentaje completado: ${stats.porcentaje}%`, 'info');
                
                if (stats.proximaCita.hora) {
                    log(`üìä Pr√≥xima cita: ${stats.proximaCita.hora} - ${stats.proximaCita.paciente}`, 'info');
                } else {
                    log(`üìä No hay m√°s citas programadas hoy`, 'info');
                }
                
                if (stats.programadas > 0) {
                    log('‚úÖ Estad√≠sticas del d√≠a calculadas correctamente', 'success');
                } else {
                    log('‚ö†Ô∏è No hay citas programadas para hoy', 'info');
                }
                
            } catch (error) {
                log('Error en test de estad√≠sticas: ' + error.message, 'error');
            }
        }
        
        function testTodayAppointments() {
            try {
                log('üß™ Test: Citas de hoy...', 'info');
                
                const appointments = GestorOrdenes.ui.getTodayAppointments();
                
                log(`üìÖ Citas encontradas para hoy: ${appointments.length}`, 'info');
                
                appointments.forEach((cita, index) => {
                    log(`  ${index + 1}. ${cita.hora_programada} - ${cita.paciente_nombre} (${cita.estado})`, 'info');
                });
                
                if (appointments.length > 0) {
                    log('‚úÖ Lista de citas del d√≠a generada correctamente', 'success');
                } else {
                    log('‚ö†Ô∏è No hay citas programadas para hoy', 'info');
                }
                
            } catch (error) {
                log('Error en test de citas: ' + error.message, 'error');
            }
        }

        // === FUNCIONES DE TEST PARA HU-2.2 (CHECK-IN INTELIGENTE) ===
        
        function testTimingValidation() {
            try {
                log('üß™ Test: Validaci√≥n de horarios...', 'info');
                
                const testCita = {
                    hora_programada: '14:00'
                };
                
                // Test a tiempo (simulando que son las 14:15)
                const testTime = new Date();
                testTime.setHours(14, 15, 0, 0);
                
                const validation = GestorOrdenes.utils.validateAppointmentTiming(testCita, testTime);
                
                log(`‚è∞ Status: ${validation.status}`, 'info');
                log(`‚è∞ Diferencia: ${validation.difference} minutos`, 'info');
                log(`‚è∞ Mensaje: ${validation.message}`, 'info');
                
                if (validation.status === 'onTime') {
                    log('‚úÖ Validaci√≥n de timing correcta (a tiempo)', 'success');
                } else {
                    log(`‚úÖ Validaci√≥n de timing correcta (${validation.status})`, 'success');
                }
                
            } catch (error) {
                log('Error en test de timing: ' + error.message, 'error');
            }
        }
        
        function testEarlyPatient() {
            try {
                log('üß™ Test: Paciente temprano...', 'info');
                
                const testCita = { hora_programada: '15:00' };
                const earlyTime = new Date();
                earlyTime.setHours(14, 20, 0, 0); // 40 minutos temprano
                
                const validation = GestorOrdenes.utils.validateAppointmentTiming(testCita, earlyTime);
                
                if (validation.status === 'early') {
                    log('‚úÖ Paciente temprano detectado correctamente', 'success');
                    log(`‚è∞ ${validation.message}`, 'info');
                } else {
                    log(`‚ùå Error: Se esperaba 'early', se obtuvo '${validation.status}'`, 'error');
                }
                
            } catch (error) {
                log('Error en test paciente temprano: ' + error.message, 'error');
            }
        }
        
        function testLatePatient() {
            try {
                log('üß™ Test: Paciente tard√≠o...', 'info');
                
                const testCita = { hora_programada: '10:00' };
                const lateTime = new Date();
                lateTime.setHours(10, 45, 0, 0); // 45 minutos tarde
                
                const validation = GestorOrdenes.utils.validateAppointmentTiming(testCita, lateTime);
                
                if (validation.status === 'late') {
                    log('‚úÖ Paciente tard√≠o detectado correctamente', 'success');
                    log(`‚è∞ ${validation.message}`, 'info');
                } else {
                    log(`‚ùå Error: Se esperaba 'late', se obtuvo '${validation.status}'`, 'error');
                }
                
            } catch (error) {
                log('Error en test paciente tard√≠o: ' + error.message, 'error');
            }
        }
        
        function testNoAppointment() {
            try {
                log('üß™ Test: Sin cita programada...', 'info');
                
                const validation = GestorOrdenes.utils.validateAppointmentTiming(null);
                
                if (validation.status === 'noAppointment') {
                    log('‚úÖ Caso sin cita detectado correctamente', 'success');
                    log(`üìÖ ${validation.message}`, 'info');
                } else {
                    log(`‚ùå Error: Se esperaba 'noAppointment', se obtuvo '${validation.status}'`, 'error');
                }
                
            } catch (error) {
                log('Error en test sin cita: ' + error.message, 'error');
            }
        }

        // === FUNCIONES DE TEST AGRUPADAS ===
        
        function testAllNotifications() {
            log('üöÄ Ejecutando todos los tests de notificaciones...', 'info');
            setTimeout(() => testNotificationDetectors(), 100);
            setTimeout(() => testUnscheduledOrders(), 500);
            setTimeout(() => {
                log('‚úÖ Tests de notificaciones completados', 'success');
            }, 900);
        }
        
        function testAllCapacity() {
            log('üöÄ Ejecutando todos los tests de capacidad...', 'info');
            setTimeout(() => testCapacityCalculation(), 100);
            setTimeout(() => testAgendaViews(), 500);
            setTimeout(() => {
                log('‚úÖ Tests de capacidad completados', 'success');
            }, 900);
        }
        
        function testAllDashboard() {
            log('üöÄ Ejecutando todos los tests de dashboard...', 'info');
            setTimeout(() => testTodayStats(), 100);
            setTimeout(() => testTodayAppointments(), 500);
            setTimeout(() => {
                log('‚úÖ Tests de dashboard completados', 'success');
            }, 900);
        }
        
        function testAllCheckin() {
            log('üöÄ Ejecutando todos los tests de check-in...', 'info');
            setTimeout(() => testTimingValidation(), 100);
            setTimeout(() => testEarlyPatient(), 300);
            setTimeout(() => testLatePatient(), 500);
            setTimeout(() => testNoAppointment(), 700);
            setTimeout(() => {
                log('‚úÖ Tests de check-in inteligente completados', 'success');
            }, 1000);
        }
        
        function testCustomDates() {
            try {
                log('üß™ Test: Fechas Personalizadas...', 'info');
                
                const fechasPersonalizadas = [
                    '2025-07-18', // Viernes
                    '2025-07-21', // Lunes  
                    '2025-07-25', // Viernes
                    '2025-07-28'  // Lunes
                ];
                
                const sesionesCustom = fechasPersonalizadas.map((fecha, index) => ({
                    orden_id: 9996,
                    numeroSesion: index + 1,
                    fecha_programada: fecha,
                    hora_programada: '11:00',
                    fecha_real: null,
                    hora_real: null,
                    estado: 'Pendiente',
                    tipo_atencion: 'programada'
                }));
                
                if (sesionesCustom.length === 4) {
                    log(`‚úÖ Generadas ${sesionesCustom.length} sesiones personalizadas`, 'success');
                    sesionesCustom.forEach((sesion, index) => {
                        const fecha = new Date(sesion.fecha_programada);
                        const dia = fecha.toLocaleDateString('es-ES', { weekday: 'long' });
                        log(`  Sesi√≥n ${index + 1}: ${sesion.fecha_programada} (${dia}) a las ${sesion.hora_programada}`, 'info');
                    });
                    
                    // Verificar que las fechas est√°n en orden cronol√≥gico
                    const ordenCorrectoFechas = sesionesCustom.every((sesion, index, array) => {
                        if (index === 0) return true;
                        return new Date(array[index - 1].fecha_programada) < new Date(sesion.fecha_programada);
                    });
                    
                    if (ordenCorrectoFechas) {
                        log('‚úÖ Las fechas personalizadas est√°n en orden cronol√≥gico correcto', 'success');
                    } else {
                        log('‚ùå ERROR: Las fechas personalizadas no est√°n ordenadas correctamente', 'error');
                    }
                    
                    // Test validaci√≥n de fechas duplicadas
                    const fechaDuplicada = '2025-07-18';
                    const tieneDuplicados = fechasPersonalizadas.filter(f => f === fechaDuplicada).length > 1;
                    
                    if (!tieneDuplicados) {
                        log('‚úÖ Validaci√≥n: No se detectaron fechas duplicadas', 'success');
                    } else {
                        log('‚ùå ERROR: Se detectaron fechas duplicadas', 'error');
                    }
                    
                } else {
                    log(`‚ùå ERROR: Se esperaban 4 sesiones personalizadas, se generaron ${sesionesCustom.length}`, 'error');
                }
                
            } catch (error) {
                log('Error en test de fechas personalizadas: ' + error.message, 'error');
            }
        }

        function runAllTests() {
            log('üöÄ Iniciando suite de pruebas...', 'info');
            clearLog();
            
            setTimeout(() => {
                log('1/4 Probando b√∫squeda...', 'info');
                testSearch();
            }, 500);
            
            setTimeout(() => {
                log('2/4 Probando creaci√≥n de orden...', 'info');
                testCreateOrder();
            }, 1000);
            
            setTimeout(() => {
                log('3/4 Probando registro de sesi√≥n...', 'info');
                testRegisterSession();
            }, 1500);
            
            setTimeout(() => {
                log('4/4 Probando generaci√≥n de presentaci√≥n...', 'info');
                testGenerateBilling();
                log('üéâ Suite de pruebas completada', 'success');
            }, 2000);
        }

        // Inicializar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(checkSystemStatus, 1000);
            log('üß™ Sistema de pruebas iniciado', 'info');
        });
    </script>
</body>
</html>